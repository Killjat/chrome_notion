name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          if [ ! -d "/root/app" ]; then
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•..."
            mkdir -p /root/app
            cd /root/app
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo "ğŸ“ è¿›å…¥é¡¹ç›®ç›®å½•..."
            cd /root/app
          fi
          
          # æ›´æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main || git pull origin master
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install
          cd client && npm install && cd ..
          
          # æ„å»ºå‰ç«¯
          echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
          cd client && npm run build && cd ..
          
          # é‡å¯æœåŠ¡
          echo "ğŸ”„ é‡å¯æœåŠ¡..."
          pm2 restart user-info-detector || pm2 start server/server.js --name user-info-detector
          
          # ä¿å­˜PM2é…ç½®
          pm2 save
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://121.43.143.169:3001"
          echo "ğŸ“‹ çœ‹æ¿åœ°å€: http://121.43.143.169:3001/kanban"